---
- name: Deploy EC2 Instances
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
  # - name: Create an EC2 key
  #   ec2_key:
  #     aws_access_key: "{{ aws_access_key_id }}"
  #     aws_secret_key: "{{ aws_secret_access_key }}"
  #     name: "devsecopskey"
  #     region: "{{ region }}"
  #   register: ec2_key
  # - name: Save private key (PEM file)
  #   copy: 
  #     content: "{{ec2_key.key.private_key}}" 
  #     dest: lookup('env', 'HOME')/.ssh/devsecopskey.pem
  #     mode: 0600
  #   when: ec2_key.changed
  - name: Create an ec2 instance
    ec2:
      key_name: devsecopskey
      group: devsecopssg
      instance_type: "{{ instance_type }}"
      image: "{{ ec2_ami }}"
      wait: true
      region: "{{ ec2_region }}"
      count: "{{ ec2_count }}"
      count_tag:
        Name: ec2_devsecops
      instance_tags:
        Name: ec2_devsecops
    register: ec2