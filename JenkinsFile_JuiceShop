#!/usr/bin/env groovy
environment {
    CHROME_BIN='/usr/bin/chromium'
}

stage('Get code from SCM') {
    node {
        checkout([$class: 'GitSCM', branches: [[name: '*/master']], userRemoteConfigs: [[url: 'https://github.com/craig-br/juice-shop.git']]])
    } 
}
// stage('Code Analysis') {
//     node {
//         def scannerHome = tool 'sonarqube'
//             withSonarQubeEnv('sonarqube'){
//                 // sh "${scannerHome}/bin/sonar-scanner -Dsonar.projectKey=craig-br_juice-shop2 -Dsonar.sources=. -Dsonar.exclusions=node_modules/*/**,test/**/* -Dsonar.tests=test"
//                 sh "${scannerHome}/bin/sonar-scanner -Dsonar.projectKey=craig-br_juice-shop -Dsonar.sources=. -Dsonar.exclusions=node_modules/*/**,test/**/*,frontend/node_modules/*/**"
//         }
//     }
// }

// stage('Code Analysis') {
//     node {
//         nodejs(nodeJSInstallationName: 'nodejs') {
//                     sh "npm run lint"
//                     sh "npm test"
//                 }

//     }
// }

stage('Build App') {
    node {
        nodejs(nodeJSInstallationName: 'nodejs') {
                        LS = "${sh(script:'node -p -e "require('./package.json').version"', returnStdout: true) }"//, returnStdout: true).trim()}"
                    sh "npm install --production && grunt package"
                }

    }
}
// stage('Deploy Cloud Instances with Tower') {
//     node {
//         ansibleTower(
//             towerServer: 'JuiceShop Tower',
//             templateType: 'workflow',
//             jobTemplate: 'Cloud Instances Workflow',
//             importTowerLogs: true,
//             jobTags: '',
//             skipJobTags: '',
//             limit: '',
//             removeColor: false,
//             verbose: true,
//             credential: '',
//         )
//     }
// }

// stage('Deploy') {
//     parallel('Deploy App with Tower': { 
//         node {
//             ansibleTower(
//                 towerServer: 'JuiceShop Tower',
//                 templateType: 'job',
//                 jobTemplate: 'Deploy JuiceShop App',
//                 importTowerLogs: true,
//                 jobTags: '',
//                 skipJobTags: '',
//                 limit: '',
//                 removeColor: false,
//                 verbose: true,
//                 credential: '',
//             )
//         }
        
//         }, 'Configure Load Balancer': {
//             node {
//                 ansibleTower(
//                     towerServer: 'JuiceShop Tower',
//                     templateType: 'job',
//                     jobTemplate: 'Create JuiceShop App VS',
//                     importTowerLogs: true,
//                     jobTags: '',
//                     skipJobTags: '',
//                     limit: '',
//                     removeColor: false,
//                     verbose: true,
//                     credential: '',
//                 )
//             }
//         }
    
//     )
// }

