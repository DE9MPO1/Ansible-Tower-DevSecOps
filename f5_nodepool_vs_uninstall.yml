---
- name: F5 Virtual Switch Uninstall
  hosts: localhost
  connection: local

  vars:
    validate_certs: no
    username: ansible
    password: candyace
    state: absent
  
  tasks:
    - name: Gather ec2 facts
        ec2_instance_facts:
      register: ec2

    - name: DeleteVS
      bigip_virtual_server:
        name: AnsibleHackazon
        state: "{{ state }}"
        provider:
          user: "{{ username }}"
          password: "{{ password }}"
          server: 10.1.20.240
          validate_certs: "{{ validate_certs }}"
          transport: rest
      when: item.key_name == 
      loop: "{{ ec2.instances }}"

    - name: DeletePoolMember1
      bigip_pool_member:
        pool: AnsibleHackazonPool
        port: 80
        host: 10.1.20.102
        preserve_node: yes
        state: "{{ state }}"
        provider:
          user: "{{ username }}"
          password: "{{ password }}"
          server: 10.1.20.240
          validate_certs: "{{ validate_certs }}"
          transport: rest

    - name: DeletePoolMember2
      bigip_pool_member:
        pool: AnsibleHackazonPool
        host: 10.1.20.102
        port: 81
        preserve_node: yes
        state: "{{ state }}"
        provider:
          user: "{{ username }}"
          password: "{{ password }}"
          server: 10.1.20.240
          validate_certs: "{{ validate_certs }}"
          transport: rest

    - name: DeletePoolMember3
      bigip_pool_member:
        pool: AnsibleHackazonPool
        host: 10.1.20.102
        port: 82
        state: "{{ state }}"
        preserve_node: no
        provider:
          user: "{{ username }}"
          password: "{{ password }}"
          server: 10.1.20.240
          validate_certs: "{{ validate_certs }}"
          transport: rest

    - name: Delete pool
      bigip_pool:
        name: AnsibleHackazonPool
        state: "{{ state }}"
        provider:
          user: "{{ username }}"
          password: "{{ password }}"
          server: 10.1.20.240
          validate_certs: "{{ validate_certs }}"
          transport: rest
